CKEDITOR.dialog.add("base64imageDialog",function(h){function i(a){if("string"!=typeof a||!a||"d"!==a.charAt(0))c.getElement().setHtml(""),alert(a);else{var e=new Image;c.getElement().setHtml("Loading...");e.onload=function(){c.getElement().setHtml("");null==d||null==f?(g=1,0<this.height&&0<this.width&&(g=this.width/this.height),0>=g&&(g=1)):f=d=null;this.id=h.id+"previewimage";this.setAttribute("style","max-width:400px;max-height:100px;");this.setAttribute("alt","");try{var a=c.getElement().$;a&&
a.appendChild(this)}catch(e){alert("Erro processando imagem.")}};e.onerror=function(){c.getElement().setHtml("")};e.onabort=function(){c.getElement().setHtml("")};e.src=a}}function m(a){c.getElement().setHtml("");if("base64"!=a)if("url"==a)n&&i(n.getValue());else if(k){var e=CKEDITOR.config.base64image_filetypes,b=j.getContentElement("tab-source","filArquivo"),a=null;try{a=b.getInputElement().$}catch(d){a=null}a&&("files"in a&&a.files&&0<a.files.length&&a.files[0])&&("type"in a.files[0]&&!a.files[0].type.match("image.("+
e+")")?alert("Tipo de arquivo não permitido."):FileReader&&(c.getElement().setHtml("Loading..."),e=new FileReader,e.onload=function(){return function(a){c.getElement().setHtml("");i(a.target.result)}}(a.files[0]),e.onerror=function(){c.getElement().setHtml("")},e.onabort=function(){c.getElement().setHtml("")},e.readAsDataURL(a.files[0])))}}var j=null,b=null,d=null,f=null,l=null,c=null,n=null,g=1,k=function(){var a=!1;try{if(FileReader){var b=document.createElement("input");b&&"files"in b&&(a=!0)}}catch(c){a=
!1}return a}(),o=k?[{type:"file",id:"filArquivo",label:"Arquivo:",size:50,onChange:function(){m("filArquivo")}},{type:"html",id:"preview",html:(new CKEDITOR.template('<div style="text-align:center;"></div>')).output()}]:[{type:"file",id:"filArquivo",size:50,label:"Arquivo:",onChange:function(){c.getElement().setHtml("");var a=j.getContentElement("tab-source","filArquivo");try{a.getInputElement()}catch(b){}c.getElement().setHtml("Loading...");l.executar()}},{type:"html",id:"preview",html:(new CKEDITOR.template('<div style="text-align:center;"></div>')).output()}];
return{title:h.lang.common.image,minWidth:450,minHeight:180,onLoad:function(){c=this.getContentElement("tab-source","preview")},onShow:function(){if(!k){var a=this.getContentElement("tab-source","filArquivo").getInputElement().$.parentNode;a.id="EditorSeiUpload";l=new infraUploadCK(a,CKEDITOR.config.base64imageUploadUrl,!0);l.finalizou=function(a){objAjaxPlugin=new infraAjaxComplementar(null,CKEDITOR.config.base64imageAjaxUrl);objAjaxPlugin.tipo=null;objAjaxPlugin.processarResultado=function(a){i(a.base64.toString())};
objAjaxPlugin.prepararExecucao=function(){return"img="+a.nome_upload};objAjaxPlugin.executar()}}c.getElement().setHtml("");j=this;f=d=null;g=1;lock=!0;(b=h.getSelection())&&(b=b.getSelectedElement());if(!b||"img"!==b.getName())b=null;if(b){if((null==d||null==f)&&b.$)d=b.$.width,f=b.$.height;null!=d&&null!=f&&(d=parseInt(d,10),f=parseInt(f,10),g=1,!isNaN(d)&&(!isNaN(f)&&0<f&&0<d)&&(g=d/f),0>=g&&(g=1));"string"==typeof b.getAttribute("src")&&(0===b.getAttribute("src").indexOf("data:")?(m("base64"),
i(b.getAttribute("src"))):j.setValueOf("tab-source","url",b.getAttribute("src")))}},onOk:function(){var a="";try{a=0<INFRA_IE&&9>INFRA_IE?CKEDITOR.document.getById(h.id+"previewimage").$.href:CKEDITOR.document.getById(h.id+"previewimage").$.src}catch(c){a=""}if(!("string"!=typeof a||null==a||""===a)){var d=b?b:h.document.createElement("img");d.setAttribute("src",a);a=[];0<a.length&&d.setAttribute("style",a.join(""));b||h.insertElement(d)}},contents:[{id:"tab-source",label:h.lang.common.generalTab,
elements:o}]}});