{% load staticfiles %}
{% load i18n %}
{% load spurl %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex, nofollow">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Editar</title>
    <link type="text/css"
            {#          href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-center-atom.css"#}
            {#          href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-center-simple.css"#}
            {#          href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-barber-shop.css"#}
          href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-loading-bar.css"
          rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"
            data-pace-options='{ "ajax": false , "restartOnRequestAfter": false, "document": false}'></script>


    <link type="text/css"
            {#          href="https://cdnjs.cloudflare.com/ajax/libs/humane-js/3.2.2/themes/flatty.min.css"#}
          href="https://cdnjs.cloudflare.com/ajax/libs/humane-js/3.2.2/themes/jackedup.min.css"
          rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/humane-js/3.2.2/humane.min.js"></script>
    <style>
        {#        .humane,#}
        {#        .humane-jackedup {#}
        {#            background-color: #d0ffcf;#}
        {#        }#}

    </style>
    {#    <link type="text/css" href="{% static "django_documentos/bootstrap/bootstrap-3.3.5-dist/css/bootstrap.min.css" %}"#}
    {#          rel="stylesheet">#}
    <link type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
          rel="stylesheet">

    {#    <link type="text/css"#}
    {#          href="{% static "django_documentos/bootstrap/bootstrap-3.3.5-dist/css/bootstrap-theme.min.css" %}"#}
    {#          rel="stylesheet">#}
    <link type="text/css"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css"
          rel="stylesheet">

    {#    <link type="text/css"#}
    {#          href="{% static "django_documentos/bootstrap/bootstrap-3.3.5-dist/fonts/glyphicons-halflings-regular.eot" %}"#}
    {#          rel="stylesheet">#}
    <link type="text/css"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/fonts/glyphicons-halflings-regular.eot"
          rel="stylesheet">


    <style>


        .doc-cabecalho {

        }

        .doc-rodape {

        }

        .doc-container {
            display: table;
        }

        .doc-content {
            display: table-row;
            height: 100%;
        }

        .doc-content-body {
            display: table-cell;
        }

        .body {
            background: rgb(204, 204, 204);
        }

        .maindiv {
            /*
            the content is hidden by default,
            and will be shown only after
            completed page load and
            finalized ckeditor startup
            */
            display: none;
        }

        .content-section {
            margin-bottom: 100px;
        }

        .article {
            background: white;
            width: 21cm;
            height: 29.7cm;
            display: block;
            margin: 0 auto 0.5cm;
            box-shadow: 0 0 0.5cm rgba(0, 0, 0, 0.5);
        {#            padding: 30px;#} font-size: 11pt;
            line-height: 22pt;
        }

{#        .article form {#}
{#            height: 100%;#}
{#        }#}

        @media print {
            body, .article[size="A4"] {
                margin: 0;
                box-shadow: 0;
                background: transparent;
            }

            .cke_pagebreak {
                display: block;
                page-break-before: always;
            }

            .content-section {
                margin-bottom: 0;
                padding-top: 0;
            }

            .no-print {
                display: none;
            }

        }

    </style>


    {#    <script src="{% static "django_documentos/js/jquery/1.11.3/jquery.min.js" %}"></script>#}
    {#    <script src="{% static "django_documentos/bootstrap/bootstrap-3.3.5-dist/js/bootstrap.min.js" %}"></script>#}
    {#    <script src="http://cdn.ckeditor.com/4.5.2/standard-all/ckeditor.js"></script>#}
    {#    #}
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    {#    <script src="http://cdn.ckeditor.com/4.5.2/full-all/ckeditor.js"></script>#}
    <script src="{% static "ckeditor/ckeditor/ckeditor.js" %}"></script>

</head>

<body class="body">
<div class="maindiv">
    <header id="menu-superior" class="navbar-fixed-top on menu-superior">
        <div class="btn-toolbar cke_top">
            <div class="btn-group">
                <button class="btn btn-default" data-original-title="Save - Ctrl+S" id="salvar" disabled="disabled"><i
                        class="glyphicon glyphicon-floppy-disk"></i>Salvar
                </button>
                <button class="btn btn-default" data-original-title="Print - Ctrl+P"><i
                        class="glyphicon glyphicon-print"></i>Imprimir
                </button>
            </div>
        </div>
        <div id="top" class="cktop">
            <!-- Menu superior CKEditor -->
        </div>
    </header>


    <div id="conteudo">
        <article class="article doc-container">

            <!-- Conteudo -->
            <form method="post" id="formulario"
                  action="



                          {% url 'documentos:update2' object.pk %}{% if popup or next_page_url %}?{% endif %}{% if popup %}popup=1{% endif %}{% if next_page_url %}&{{ next_kwarg_name }}={{ next_page_url }}{% endif %}">

                {% csrf_token %}
                {#            {{ form }}#}
                <header id="ta-cabecalho" class="header ta-cabecalho">
                    {{ form.cabecalho }}
                </header>

                <section id="ta-conteudo" class="doc-content">
                    <div class="doc-content-body">
                        {{ form.conteudo }}
                    </div>
                </section>

                <footer id="ta-rodape" class="footer ta-rodape">
                    {{ form.rodape }}
                </footer>


            </form>
        </article>
    </div>
    <footer id="menu-inferior" class="navbar-fixed-bottom menu-inferior">
        <div id="bottom">
            <!--  Menu inferior CKEditor  -->
        </div>
        <div class="btn-toolbar cke_bottom">
            <button class="btn btn-default" id="areateste">
            </button>
            <div class="pull-right" id="status-bar">Documento: {{ object.identificador_versao }}</div>
        </div>
    </footer>
</div>

<script>
    function get_ckenabledElementIds() {
        return $('[data-djckeditor]').map(function (i) {
            return this.id;
        }).get();
    }

    var ckenabledElementIds = get_ckenabledElementIds();


    var ckeditor_config = {
        extraPlugins: [
            'sharedspace',
            'save',
            'autolink',
            {#            'autogrow'#}
        ].join(),
        removePlugins: 'resize',
        'sharedSpaces': {
            'top': 'top',
            'bottom': 'bottom'
        },
        addCss: '.fabio .cke_reset { border: none; box-shadow: none; }',
        {#        autoGrow_onStartup: true,#}
        contentsCss: 'html, iframe, body {overflow:hidden;outline: none;}',
        startupShowBorders: false,
        toolbarGroups: [
            {name: 'document', groups: ['mode', 'document', 'doctools']},
            {name: 'clipboard', groups: ['clipboard', 'undo']},
            {name: 'editing', groups: ['find', 'selection', 'spellchecker', 'editing']},
            {name: 'forms', groups: ['forms']},
            {#            '/',#}
            {name: 'basicstyles', groups: ['basicstyles', 'cleanup']},
            {name: 'paragraph', groups: ['list', 'indent', 'blocks', 'align', 'bidi', 'paragraph']},
            {name: 'links', groups: ['links']},
            {name: 'insert', groups: ['insert']},
            '/',
            {name: 'styles', groups: ['styles']},
            {name: 'colors', groups: ['colors']},
            {name: 'tools', groups: ['tools']},
            {name: 'others', groups: ['others']},
            {name: 'about', groups: ['about']}
        ],
        removeButtons: 'Source,Save,NewPage,Preview,Print,Templates,Form,Checkbox,Radio,TextField,Textarea,Select,Button,ImageButton,HiddenField,CreateDiv,BidiLtr,BidiRtl,Language,Anchor,Unlink,Link,Flash,Smiley,SpecialChar,Iframe,About'
    };

    function startCkEditor() {
        {#        var dict = {};#}
        ckenabledElementIds.map(function (id_elemento) {
            CKEDITOR.replace(id_elemento, ckeditor_config);
            {#            dict[id_elemento] = CKEDITOR.replace(id_elemento, ckeditor_config);#}
        });
        {#        return dict;#}
    }

    startCkEditor();


    function beforeUnload(evt) {
        var item_nao_salvo = false;
        for (var instance in CKEDITOR.instances) {
            if (CKEDITOR.instances[instance].checkDirty()) {
                item_nao_salvo = true;
            }
        }
        if (item_nao_salvo) {
            return evt.returnValue = "{% trans "O documento possui modificações e ainda não foi salvo" %}";
        }
    }

    {% if not debug %}
        if (window.addEventListener) {
            window.addEventListener('beforeunload', beforeUnload, false);
        } else {
            window.attachEvent('onbeforeunload', beforeUnload);
        }
    {% endif %}



    //http://brack3t.com/ajax-and-django-views.html
    //https://github.com/wavded/humane-js
    //https://github.com/alertifyjs/alertify.js
    //versao 2
    $(document).ready(function () {
        var requestRunning = false;

        var conteudo_modificado = {};

        var $botao_salvar = $("#salvar");
        var $formulario = $("#formulario");


        function ativarDesativarSalvar() {
            var ativar = false;
            for (var key in conteudo_modificado) {
                ativar = conteudo_modificado[key];
                if (ativar) {
                    break;
                }
            }
            if (ativar) {
                $botao_salvar.prop('disabled', false);
            }
            else {
                $botao_salvar.prop('disabled', true);
            }
            return ativar;

        }

        for (var instance in CKEDITOR.instances) {
            var id_elemento = "" + instance;
            conteudo_modificado[id_elemento] = false;
            CKEDITOR.instances[id_elemento].on('change', function () {

                if (CKEDITOR.instances[this.name].checkDirty()) {
                    conteudo_modificado[this.name] = true;

                } else {
                    conteudo_modificado[this.name] = false;


                }
                ativarDesativarSalvar();

            });

        }
        function django_message(msg, level) {
            console.log("Level: ", level, 'MSG: ', msg)
        }

        function apply_form_field_error(fieldname, error) {
            var input = $("#id_" + fieldname),
                    container = $("#div_id_" + fieldname),
                    error_msg = $("<span />").addClass("help-inline ajax-error").text(error[0]);

            container.addClass("error");
            error_msg.insertAfter(input);
        }

        function clear_form_field_errors(form) {
            $(".ajax-error", $(form)).remove();
            $(".error", $(form)).removeClass("error");
        }

        //seu codigo lindo aqui
        $formulario.submit(function (event) {
            // Stop form from submitting normally
            event.preventDefault();


            if (requestRunning) { // don't do anything if an AJAX request is pending
                return;
            }

            for (var instance in CKEDITOR.instances) {
                CKEDITOR.instances[instance].updateElement();
            }
            // Get some values from elements on the page:
            var $form = $(this);
            var conteudo = $form.serializeArray();
            var url = $form.attr("action");

            clear_form_field_errors($form);
            requestRunning = true;
            // Send the data using post
            // parametros url, data, callback, type
            // sendo que callback é sucess
            var posting = $.post(url, conteudo, 'JSON');

            // Put the results in a div
            posting.fail(function (jqXHR, textStatus, errorThrown) {
                {#                                        console.log("fail textStatus:", textStatus);#}
                {#                                        console.log("fail errorThrown:", errorThrown);#}
                {#                                        var content = textStatus;#}
                {#                                        $("#results").empty().append(content);#}


                var errors = jqXHR.responseJSON;
                {#                    var errors = $.parseJSON(jqXHR.responseText);#}
                console.log(errors);
                var msg = "Erro ao salvar documento" + errors.document_number + "\n";
                humane.log(msg, {
                    timeout: 2500,
                    clickToClose: true,
                    addnCls: 'humane-error'
                });
                {#                $.each(errors, function (index, value) {#}
                {#                    if (index === "__all__") {#}
                {#                        django_message(value[0], "error");#}
                {#                    } else {#}
                {#                        apply_form_field_error(index, value);#}
                {#                    }#}
                {#                });#}


            });
            // Put the results in a div
            posting.done(function (data, textStatus, jqXHR) {
                console.log("done data:", data);
                console.log("done textStatus:", textStatus);
                console.log("done jqXHR:", jqXHR);
                var content = $(data);
                console.log($(data));
                for (var instance in CKEDITOR.instances) {
                    CKEDITOR.instances[instance].resetUndo();
                    conteudo_modificado[instance] = false;
                }
                ativarDesativarSalvar();
                var mensagem = "Documento N° " + data.document_number + " salvo com sucesso!";
                humane.log(mensagem, {
                    timeout: 2500,
                    clickToClose: true,
                    addnCls: 'humane-sucess'
                });
                $("#status-bar").empty().append('Documento: ' + data.identificador_versao);
            });
            posting.always(function (data, textStatus, errorThrown) {
                console.log("always");
                requestRunning = false;
            });
        }).bind('ajax:complete', function () {

            // tasks to do
            console.log("ajax completo");


        });
        $botao_salvar.click(function () {

            $("#formulario").submit();

        });


    });


    // This function gets cookie with a given name
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var csrftoken = getCookie('csrftoken');

    /*
     The functions below will create a header with csrftoken
     */

    function csrfSafeMethod(method) {
        console.log('csrfSafeMethod');
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    function sameOrigin(url) {
        console.log('sameOrigin');
        // test that a given url is a same-origin URL
        // url could be relative or scheme relative or absolute
        var host = document.location.host; // host + port
        var protocol = document.location.protocol;
        var sr_origin = '//' + host;
        var origin = protocol + sr_origin;
        // Allow absolute or scheme relative URLs to same origin
        return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                    // or any other URL that isn't scheme relative or absolute i.e relative.
                !(/^(\/\/|http:|https:).*/.test(url));
    }

    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            console.log('beforeSend');
            if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                // Send the token to same-origin, relative URLs only.
                // Send the token only if the method warrants CSRF protection
                // Using the CSRFToken value acquired earlier
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });


</script>


<script>
    function corrigir_padding_conteudo() {
        var menusuperior = $('#menu-superior');
        var conteudo = $('#conteudo');
        var altura_menu_superior = parseInt(menusuperior.css('height').replace(/[^-\d\.]/g, ''));
        var valor = "".concat(altura_menu_superior + 130).concat("px");
        conteudo.css('padding-top', valor);
        console.log('corrigindo');
    }
    {#    $(window).resize(function () {#}
    {#        corrigir_padding_conteudo();#}
    {#    });#}
    window.addEventListener('resize.corrigir_padding_conteudo', corrigir_padding_conteudo, false);

    Pace.on('hide', function () {

        $(".maindiv").fadeIn("fast");
        corrigir_padding_conteudo();
    });
</script>
{#<script>#}
{#    function resizeToMinimum() {#}
{#        var minimum = [878, 600];#}
{#        var current = [window.outerWidth, window.outerHeight];#}
{#        var restricted = [];#}
{#        var i = 2;#}
{##}
{#        while (i-- > 0) {#}
{#            restricted[i] = mimimum[i] > current[i] ? minimum[i] : current[i];#}
{#        }#}
{#        console.log("redimencionando x:" + current[0] + " - y:" + current[1]);#}
{#        window.resizeTo(current[0], current[1]);#}
{##}
{#    }#}
{##}
{#    window.addEventListener('resize', resizeToMinimum, false)#}
{#</script>#}


</body>

</html>